{% extends 'datas/../layout.html' %}

{% block breadcrum %}


<div class="header bg-dark pb-6">
    <div class="container-fluid">
        <div class="header-body">
            <div class="row align-items-center py-4">
                <div class="col-lg-6 col-7">
                    <h6 class="h2 text-yellow d-inline-block mb-0">Données</h6>
                    <nav aria-label="breadcrumb" class="d-none d-md-inline-block ml-md-4">
                        <ol class="breadcrumb breadcrumb-links breadcrumb-yellow">
                            <li class="breadcrumb-item"><a href="#"><i class="fas fa-home"></i></a></li>
                            <li class="breadcrumb-item active" aria-current="page">Données</li>
                        </ol>
                    </nav>
                </div>
                <div class="col-lg-6 col-5 text-right">
                    <a href="#modal-upload" class="btn btn-lg btn-secondary"  data-toggle="modal" data-target="#modal-upload"><i class="fa fa-file mr-1"></i>Charger un fichier de données</a>
                    <a href="#" class="btn btn-lg btn-secondary"><i class="fa fa-database mr-1"></i>Configurer</a>
                    <a href="#modal-control" class="btn btn-lg btn-secondary" data-toggle="modal" data-target="#modal-control"><i class="fa fa-check mr-1"></i>Control</a>
                </div>
            </div>
        </div>
    </div>
</div>


{% endblock breadcrum %}




{% block content %}

<div class="container-fluid mt--6">
    <div class="row justify-content-center">

        <div class=" col ">
            <div class="card">
                <div class="card-header bg-transparent">
                    <div class="row">
                        <div class="col-lg-6 col-5">
                            <h3 class="mb-0">Enregistrement d'un état</h3>
                        </div>
                        <div class="col-lg-6 col-5 text-right">
                            <div class="btn-group">
                                <ul class="nav nav-pills nav-fill flex-column flex-md-row" id="tabs-icons-text" role="tablist">
                                    <li class="nav-item">
                                        <a class="nav-link " href="{% url 'discipline_list' %}"><i class="fa fa-arrow-left"></i>&nbsp;Retourner à la liste</a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
               <div class="card-body">
                   <h1>{% if object.pk %}Edit{% else %}Create{% endif %} Etat (Discipline)</h1>
                    <form method="POST">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="{{ form.person.id_for_label }}">Personne</label>
                            <select name="{{ form.person.name }}" id="{{ form.person.id_for_label }}" class="form-control">
                                <option value=""></option>
                                {% for choice in persons %}
                                    <option value="{{ choice.id }}" {% if choice.id == form.person.value %}selected{% endif %}>
                                        {{ choice.last_name }} {{ choice.first_name }} - {{ choice.job.job_title }}
                                    </option>
                                {% endfor %}
                            </select>
                            {% if form.person.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.person.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.discipline_type.id_for_label }}">Type</label>
                            <select name="{{ form.discipline_type.name }}" id="{{ form.discipline_type.id_for_label }}" class="form-control">
                                <option value=""></option>
                                {% for choice in types %}
                                    <option value="{{ choice.0 }}" {% if choice.0 == form.discipline_type.value %}selected{% endif %}>
                                        {{ choice.1 }}
                                    </option>
                                {% endfor %}
                            </select>
                            {% if form.discipline_type.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.discipline_type.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.discipline_date.id_for_label }}">Date *</label>
                            <input type="date" name="{{ form.discipline_date.name }}" id="{{ form.discipline_date.id_for_label }}" value="{{ form.discipline_date.value|date:'Y-m-d' }}" class="form-control" required>
                            {% if form.discipline_date.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.discipline_date.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.discipline_heure.id_for_label }}">Heure *</label>
                            <input type="time" name="{{ form.discipline_heure.name }}" id="{{ form.discipline_heure.id_for_label }}" value="{{ form.discipline_heure.value|date:'H:i' }}" class="form-control" required>
                            {% if form.discipline_heure.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.discipline_heure.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.discipline_heure.id_for_label }}">Position *</label>
                            <div class="row">
                                <div class="col-md-6">
                                    <input type="number" min="0.0" name="latitude" id="latitude" value="0.0" class="form-control" required>
                                </div>
                                <div class="col-md-6">
                                    <input type="number" min="0.0" name="latitude" id="longitude" value="0.0" class="form-control" required>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="{{ form.discipline_motif.id_for_label }}">Motif </label>
                            <textarea type="text" name="{{ form.discipline_motif.name }}" id="{{ form.discipline_motif.id_for_label }}" class="form-control">{{ form.discipline_motif.value }}</textarea>
                            {% if form.discipline_motif.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.discipline_motif.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="form-group">
                            <div id="map"></div>
                        </div>
                        <button type="submit" class="btn btn-primary">{{ action }}</button>
                    </form>
                    <a  class="btn btn-link" href="{% url 'organisation_list' %}">Annuler</a>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock content %}


{% block style %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map {
            height: 500px;
        }
    </style>
{% endblock %}

{% block script %}
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function updateLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const latitude = position.coords.latitude;
                    const longitude = position.coords.longitude;

                    $("#latitude").val(latitude);
                    $("#longitude").val(longitude);

                    // Afficher la position sur la carte
                    var map = L.map('map').setView([latitude, longitude], 18); // Zoom initial amélioré
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    }).addTo(map);

                    var marker = L.marker([latitude, longitude]).addTo(map);
                    marker.bindPopup("<b>You are here!</b>").openPopup();

                    // Ajouter des contrôles supplémentaires
                    L.control.zoom({
                        position: 'topright'
                    }).addTo(map);
                }, function(error) {
                    console.error(error);
                }, {
                    enableHighAccuracy: true,
                    timeout: 10000, // Augmenter le timeout pour plus de précision
                    maximumAge: 0 // Limiter l'âge des données de localisation
                });
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        function checkProximity(targetLat, targetLon) {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const userLat = position.coords.latitude;
                    const userLon = position.coords.longitude;

                    const distance = getDistanceFromLatLonInMeters(userLat, userLon, targetLat, targetLon);

                    if (distance <= 50) {
                        alert('You are within 50 meters of the target location.');
                    } else {
                        alert('You are more than 50 meters away from the target location.');
                    }

                    console.log(`Distance to target: ${distance} meters`);
                });
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        function getDistanceFromLatLonInMeters(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Rayon de la Terre en mètres
            const φ1 = lat1 * Math.PI / 180; // Latitude en radians
            const φ2 = lat2 * Math.PI / 180; // Latitude en radians
            const Δφ = (lat2 - lat1) * Math.PI / 180; // Différence de latitude en radians
            const Δλ = (lon2 - lon1) * Math.PI / 180; // Différence de longitude en radians

            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c; // Distance en mètres
        }

        updateLocation();
    </script>
{% endblock %}